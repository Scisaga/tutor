## 影响因素分析

1. 表结构
   - 使用MyISAM/MEMORY引擎（按需） 
   - 使用FIXED记录格式 
2. 网络 
   - mysql连接使用的tcp协议，网络层主要影响因素包括：1) 插入请求次数 2) 总数据量/带宽 3) 发包数
      - 使用prepareStatement 
      - 拼接Insert，例如：Insert into t1 (a,b,c,d) values (1,2,3,’2010-01-01’), (3,5,6,’2010-02-01’), (7,8,9,’2010-03-01’);
3. CPU 
   - 控制拼接/解析sql所消耗的CPU资源：调整拼接Insert语句中的条目数量
4. 延迟写入
   ```
   Insert delayed into t1 (a,b,c,d) values (1,2,3,’2010-01-01’), (3,5,6,’2010-02-01’), (7,8,9,’2010-03-01’);
   ```
5. 写入缓存
   - `bulk_insert_buffer_size = 32M`
   - [set bulk_insert_buffer_size in mysql](http://dba.stackexchange.com/questions/54197/how-to-set-bulk-insert-buffer-size-in-mysql)
6. 并行写入 
   - concurrent_insert = 2 
   - 注：并行写入与延迟写入二选一
7. 查询缓存 
   - 禁用查询缓存，减少不必cpu/io消耗：
   - `query_cache_limit = 0`
   - `query_cache_size = 0`
8. 索引
   - 批量插入前禁用索引
   `ALTER TABLE t1 DISABLE KEYS;`
   - 如果无法禁用索引，增加key_buffer_size
   `key_buffer_size = 256M`

## 数据写入实验

### A) preparedStatement / 拼接Insert 数据写入对比分析
| 总数据条目 | 100,000          |
|-------|------------------|
| 数据形式  | 8 * 8 + 1 byte   |
| 试验方式  | 本机多线程连接远程数据库写入数据 |
| 结果描述  | 全部线程结束时间         |

#### 1) 采集数据
| 参数                     | 拼接Insert耗时(s) | preparedStatement耗时(s) |
|------------------------|---------------|------------------------|
| Batch: 10, Thread: 4.  | 5.293         | 37.858                 |
| Batch: 10, Thread: 8.  | 3.135         | 21.365                 |
| Batch: 20, Thread: 4.  | 3.218         | 37.748                 |
| Batch: 20, Thread: 8.  | 1.963         | 21.258                 |
| Batch: 50, Thread: 4.  | 3.323         | 36.178                 |
| Batch: 50, Thread: 8.  | 3.257         | 19.628                 |
| Batch: 100, Thread: 4. | 5.892         | 36.012                 |
| Batch: 100, Thread: 8. | 6.566         | 20.466                 |


#### 2) 初步结论

* 拼接Insert性能更好，并且对拼接条目数（Batch）非常敏感
* preparedStatement的性能与Batch相关性不大

### B) 拼接Insert最优条目数分析
| 总数据条目 | 100,000          |
|-------|------------------|
| 试验方式  | 本机多线程连接远程数据库写入数据 |
| 结果描述  | 全部线程结束时间         |

#### 1) 采集数据

* C: 数据项数量（单条数据 = 8 * C + 1 byte）
* T: 线程数/客户端数
* B: 拼接条目数
* R: 全部线程完成时间

##### C=1
| T\B | 5      | 10     | 20    | 50    | 100       | 200   | 500   | 1000  |
|-----|--------|--------|-------|-------|-----------|-------|-------|-------|
| 1   | 20.353 | 10.312 | 5.782 | 2.591 | 2.292     | 1.455 | 1.613 | 2.613 |
| 2   | 10.705 | 5.712  | 3.171 | 1.697 | 0.943     | 0.809 | 1.185 | 1.91  |
| 3   | 9.006  | 4.194  | 1.866 | 1.079 | 0.696     | 0.697 | 0.946 | 1.821 |
| 4   | 6.992  | 3.292  | 1.782 | 0.793 | 0.615     | 0.47  | 0.961 | 1.984 |
| 5   | 5.813  | 3.004  | 1.49  | 0.682 | 0.514     | 0.424 | 0.96  | 2.003 |
| 6   | 4.958  | 2.632  | 1.213 | 0.679 | 0.453     | 0.412 | 0.984 | 1.979 |
| 7   | 4.668  | 2.357  | 1.162 | 0.614 | **0.384** | 0.408 | 0.998 | 2.024 |
| 8   | 4.076  | 2.154  | 1.089 | 0.522 | 0.391     | 0.411 | 1.03  | 2.026 |
##### C=2
| T\B | 5      | 10     | 20    | 50    | 100         | 200   | 500   | 1000  |
|-----|--------|--------|-------|-------|-------------|-------|-------|-------|
| 1   | 19.83  | 11.055 | 6.851 | 4.038 | 3.475       | 2.581 | 3.914 | 6.762 |
| 2   | 12.066 | 6.286  | 3.409 | 2.179 | 1.294       | 1.522 | 2.948 | 5.157 |
| 3   | 9.012  | 4.321  | 2.504 | 1.532 | 0.896       | 1.204 | 2.568 | 5.452 |
| 4   | 6.883  | 3.374  | 1.881 | 0.874 | 0.787       | 1.088 | 2.673 | 5.761 |
| 5   | 5.835  | 3.208  | 1.612 | 0.852 | 0.739       | 1.113 | 2.74  | 5.889 |
| 6   | 5.049  | 2.872  | 1.391 | 0.85  | 0.638       | 1.099 | 2.789 | 5.718 |
| 7   | 4.582  | 2.539  | 1.315 | 0.772 | **0.603** | 1.158 | 2.936 | 5.918 |
| 8   | 4.073  | 2.199  | 1.21  | 0.656 | 0.622       | 1.149 | 2.991 | 5.854 |
##### C=4
| T\B | 5      | 10     | 20    | 50          | 100   | 200   | 500    | 1000   |
|-----|--------|--------|-------|-------------|-------|-------|--------|--------|
| 1   | 20.904 | 14.554 | 8.153 | 4.759       | 4.568 | 5.653 | 11.132 | 23.657 |
| 2   | 11.981 | 7.414  | 4.778 | 2.508       | 2.504 | 4.04  | 8.358  | 19.105 |
| 3   | 8.837  | 4.957  | 3.198 | 1.819       | 1.984 | 3.414 | 8.902  | 18.22  |
| 4   | 6.866  | 4.056  | 2.792 | 1.629       | 1.827 | 3.385 | 9.276  | 18.656 |
| 5   | 6.043  | 3.698  | 2.252 | 1.389       | 1.771 | 3.478 | 9.395  | 19.106 |
| 6   | 5.248  | 3.082  | 2.008 | 1.232       | 1.796 | 3.606 | 9.527  | 18.702 |
| 7   | 4.805  | 2.837  | 1.799 | 1.135       | 1.844 | 3.631 | 9.537  | 19.255 |
| 8   | 4.173  | 2.529  | 1.516 | **1.059** | 1.875 | 3.667 | 9.79   | 19.03  |

##### C=8
| T\B | 5      | 10     | 20         | 50    | 100    | 200    | 500        | 1000   |
|-----|--------|--------|------------|-------|--------|--------|------------|--------|
| 1   | 29.657 | 16.686 | 9.907      | 8.537 | 10.347 | 17.529 | 43.35      | 95.663 |
| 2   | 14.751 | 10.477 | 5.19       | 4.827 | 7.286  | 13.032 | 33.901     | 68.906 |
| 3   | 9.862  | 7.256  | 3.872      | 3.708 | 6.146  | 12.351 | 32.373     | 66.489 |
| 4   | 8.124  | 5.65   | 3.182      | 3.311 | 5.997  | 12.925 | **33.064** | 68.664 |
| 5   | 6.648  | 4.673  | 2.675      | 3.15  | 6.22   | 13.235 | **33.65**  | 70.344 |
| 6   | 5.978  | 3.959  | 2.292      | 3.156 | 6.276  | 13.423 | **34.007** | 69.613 |
| 7   | 5.598  | 3.395  | 2.085      | 3.216 | 6.498  | 13.581 | **34.139** | 72.474 |
| 8   | 4.785  | 3.182  | **1.917**  | 3.318 | 6.638  | 13.663 | **34.884** | 72.274 |

##### C=16
| T\B | 5      | 10          | 20     | 50     | 100    | 200 | 500 | 1000 |
|-----|--------|-------------|--------|--------|--------|-----|-----|------|
| 1   | 32.81  | 17.566      | 15.543 | 21.532 | 35.883 | N/A | N/A | N/A  |
| 2   | 18.441 | 11.43       | 9.38   | 14.29  | N/A    | N/A | N/A | N/A  |
| 3   | 13.417 | 8.175       | 6.9    | 11.776 | N/A    | N/A | N/A | N/A  |
| 4   | 10.101 | 6.453       | 5.942  | 11.493 | N/A    | N/A | N/A | N/A  |
| 5   | 8.714  | 5.247       | 5.365  | 11.738 | N/A    | N/A | N/A | N/A  |
| 6   | 7.483  | 4.556       | 5.009  | 11.974 | N/A    | N/A | N/A | N/A  |
| 7   | 6.499  | 4.124       | 4.953  | 12.033 | N/A    | N/A | N/A | N/A  |
| 8   | 5.818  | **3.749**   | 4.963  | 12.395 | N/A    | N/A | N/A | N/A  |


#### 2) 猜想（有待进一步证实）

* 最优匹配情况中：**C * R ≈ 常数**，**C * B ≈ 常数**。
* 在本次测试中，单次请求数据量约为1kb时，写入性能最佳。这个数据可能与本机/目标机网卡性能、路由器性能相关。

## 异常情况
### innodb_buffer_pool_size 设置较大时的数据插入情况
在innodb_buffer_pool_size设置较大时, 如 `innodb_buffer_pool_size = 32G`，特定innodb表的大量多线程零散插入情况:
* 初始的插入速度会非常快, 因为是向缓存中插入数据(内存)
* 但是每隔一段时间性能会下降, 因为mysql将缓存写入磁盘导致的io瓶颈
* 当数据插入到一定量级后, 插入速度回恢复真实速率.

## 参考

* [MYSQL SPEEPUP INSERT INTO A MYISAM TABLE](http://databobjr.blogspot.com/2010/10/mysql-speepup-insert-into-myisam-table.html)
* [Concurrent Inserts](http://dev.mysql.com/doc/refman/5.1/en/concurrent-inserts.html)
* [Speed of INSERT Statements](http://dev.mysql.com/doc/refman/5.0/en/insert-speed.html)
* [MySQL Server Connection System Variables Setting and Tuning](http://databobjr.blogspot.com/2010/03/mysql-performance-tunning-server.html)
