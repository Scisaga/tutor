## 套字协议
套字协议（Protocol Stack）是一组用于网络通信的协议层次结构，每一层负责特定的网络通信功能。每一层的协议可以独立开发、更新，并且相互之间通过清晰的接口通信。这种分层结构有助于将复杂的网络通信问题简化和模块化。

在套字协议的分层架构中，通常有以下几个层次：
- 应用层：负责应用程序之间的通信（如HTTP、FTP等）。
- 传输层：提供端到端的通信服务（如TCP、UDP）。
- 网络层：负责数据包的路由和转发（如IP协议）。
- 数据链路层：负责在同一网络中节点之间的传输（如以太网协议）。
- 物理层：处理比特流的实际传输（如电缆、光纤等）。

### OSI模型

OSI模型：开放系统互连（OSI）模型将通信协议分为七层，从物理层到应用层。各层的具体职责如下：
- 物理层：负责比特流的传输。
- 数据链路层：处理节点之间的可靠传输。
- 网络层：负责数据包的路由和转发。
- 传输层：提供端到端的传输服务。
- 会话层：管理会话的建立、维护和终止。
- 表示层：负责数据格式化、加密、解密。
- 应用层：为应用程序提供网络服务。

### 核心概念

- 层次分离：
   - 每一层专门处理特定的任务，如物理传输、数据封装、路由、连接管理等。通过这种任务分离，可以降低通信的复杂性。
- 模块化设计：
   - 每一层的协议可以独立设计和开发，而不会影响到其他层。例如，传输层的协议可以是TCP或UDP，但对应用层和网络层的工作基本没有直接影响。
- 标准化接口：
   - 各层之间通过标准化的接口进行通信，使得不同的层次之间可以进行数据交换。接口的标准化使得协议的实现具有灵活性和互操作性。
- 封装与解封：
   - 发送数据时，每一层都会将数据封装为更小的单元，直到物理层进行传输；接收方则反向逐层解封。这种封装和解封机制确保数据可以安全传输，并且不同网络节点可以理解数据包的结构。
- 互相依赖： 
   - 每一层的协议提供服务给上一层，依赖于下一层。例如，应用层的HTTP协议依赖传输层的TCP协议来保证数据传输的可靠性，而TCP协议依赖网络层的IP协议来实现数据包的路由。

### 封装 / 解封
- 数据传递的流程： 
   - 当应用程序要发送数据时，它需要经过每一层进行处理，每一层会在数据前添加自己的协议头（封装）。这些协议头包括每一层所需的信息，例如网络层的IP地址、传输层的端口号等。
数据到达目的地时，会反向进行“解封”，每一层会读取并移除自己所加的协议头，直到最终将实际数据交给应用程序。
- 隔离功能： 
   - 每一层只处理自己负责的任务，封装和解封的机制确保了每一层只需要关心如何处理数据，并不需要了解其他层的内部工作原理。例如，传输层只关注数据是否可靠传输，而不需要了解数据链路层如何实际发送比特流。
- 增强灵活性： 
   - 封装允许不同层次的协议可以在同一网络中同时使用。例如，HTTP可以使用TCP作为传输协议，而TCP则可以通过IP进行路由，IP则依赖于数据链路层进行实际的数据传输。各层之间的独立性使得协议可以独立更新或更替，而不会影响其他层。

## 以太帧

直接从链路层开始分析。在链路层中，使用的最多的是以太网，而以太网帧因为历史原因存在多个版本，这里采用IEEE802.3以太网帧格式。来自线路的二进制数据包称作一个帧。从物理线路上看到的帧，除其他信息外，还可看到前导码和帧开始符。（前导码和帧开始符无法在包嗅探程序中显示。这些信息会在OSI第1层被网卡处理掉，而不会传入嗅探程序采集数据的OSI第2层。）

<table class="wikitable" style="text-align: center;">
<caption>802.3 以太网帧结构</caption>
<tbody>
	<tr>
		<th>前导码</th>
		<th>帧开始符</th>
		<th>MAC 目标地址</th>
		<th>MAC 源地址</th>
		<th>802.1Q 标签 (可选)</th>
		<th>以太类型</th>
		<th>负载</th>
		<th>冗余校验</th>
		<th>帧间距
		</th>
	</tr>
	<tr>
		<td>10101010 7个octet</td>
		<td>10101011 1个octet</td>
		<td>6 octets</td>
		<td>6 octets</td>
		<td>(4 octets)</td>
		<td>2 octets</td>
		<td>46–1500 octets</td>
		<td>4 octets</td>
		<td>12 octets</td>
	</tr>
	<tr>
		<td colspan="2"></td>
		<td colspan="6" style="background:#69c;">64–1522 octets</td>
		<td>
		</td>
	</tr>
	<tr>
		<td colspan="8" style="background:#69c;">72–1530 octets</td>
		<td></td>
	</tr>
	<tr>
		<td colspan="9" style="background:#69c;">84–1542 octets</td>
	</tr>
</tbody></table>

- octet == 字节
- 前导码和帧开始符
   - 一个帧以7个字节的前导码和1个字节的帧开始符作为帧的开始。快速以太网之前，在线路上帧的这部分的位模式是10101010 10101010 10101010 10101010 10101010 10101010 10101010 10101011。由于在传输一个字节时最低位最先传输(LSB)，因此其相应的16进制表示为0x55 0x55 0x55 0x55 0x55 0x55 0x55 0xD5。
   - 10/100M 网卡(介质无关接口 PHY)一次传输4位(一个半字节)。因此前导符会成为7组0x5+0x5,而帧开始符成为0x5+0xD。1000M网卡(GMII)一次传输8位，而10Gbit/s(XGMII) PHY芯片一次传输32位。 注意当以octet描述时，先传输7个01010101然后传输11010101。由于8位数据的低4位先发送，所以先发送帧开始符的0101，之后发送1101。
- 报头 
   - 报头包含源地址和目标地址的MAC地址，以太类型字段和可选的用于说明VLAN成员关系和传输优先级的IEEE 802.1Q VLAN 标签。
- 帧校验码
   - 帧校验码是一个32位循环冗余校验码，以便验证帧数据是否被损坏。
- 帧间距
   - 当一个帧发送出去之后，发送方在下次发送帧之前，需要再发送至少12个octet的空闲线路状态码。

## IP帧
IP（Internet Protocol，互联网协议）是网络通信的核心协议之一，主要负责将数据从源设备传输到目标设备。为了使数据能够在物理网络上传输，IP数据包会经过数据链路层的封装，形成链路层帧，即IP帧。

| **部分**           | **字段**               | **描述**                                                   |
|--------------------|------------------------|------------------------------------------------------------|
| **链路层帧头**     | 目标MAC地址            | 接收方的MAC地址                                             |
|                    | 源MAC地址              | 发送方的MAC地址                                             |
|                    | 帧类型（EtherType）     | 指示上层协议类型（例如IP协议：0x0800表示IPv4，0x86DD表示IPv6）|
| **IP数据包头**     | 版本号                 | 指定IP协议版本（IPv4或IPv6）                                |
|                    | 头部长度               | IP头部的长度，IPv4通常为20字节                              |
|                    | 服务类型（ToS）         | 数据包的优先级和服务质量（QoS）设置                          |
|                    | 总长度                 | IP数据包的总长度，包括头部和数据                            |
|                    | 标识符（Identification）| 用于分片的唯一标识                                          |
|                    | 标志位和片偏移（Flags & Fragment Offset） | 控制数据包的分片及重组                                      |
|                    | 生存时间（TTL）         | 数据包在网络中的最大跳数，防止数据包在网络中无限循环         |
|                    | 协议                   | 指定承载的上层协议类型（如TCP：6，UDP：17，ICMP：1）        |
|                    | 头部校验和             | IP头部的错误检测                                            |
|                    | 源IP地址               | 数据包的发送方IP地址                                        |
|                    | 目标IP地址             | 数据包的接收方IP地址                                        |
| **IP数据部分**     | 数据（Payload）         | 上层协议传输的数据（例如TCP段、UDP数据报或ICMP消息）        |
| **帧尾（FCS）**    | 帧校验序列（FCS）      | 用于检测帧在传输过程中是否出错，通常是循环冗余校验（CRC）  |


## UDP帧
用户数据报协议（英语：User Datagram Protocol，缩写：UDP；又称用户数据包协议）是一个简单的面向数据报的通信协议。UDP只提供数据的不可靠传递，它一旦把应用程序发给网络层的数据发送出去，就不保留数据备份（所以UDP有时候也被认为是不可靠的数据报协议）。UDP在IP数据报的头部仅仅加入了复用和数据校验字段。

许多关键的互联网应用程序使用UDP，包括：
- 域名系统（DNS），其中查询阶段必须快速，并且只包含单个请求，后跟单个回复数据包；
- 动态主机配置协议（DHCP），用于动态分配IP地址；
- 简单网络管理协议（SNMP）；
- 路由信息协议（RIP）；
- 网络时间协议（NTP）。
流媒体、在线游戏流量通常使用UDP传输。 实时视频流和音频流应用程序旨在处理偶尔丢失、错误的数据包，因此只会发生质量轻微下降，而避免了重传数据包带来的高延迟。 由于TCP和UDP都在同一网络上运行，因此一些企业发现来自这些实时应用程序的UDP流量影响了使用TCP的应用程序的性能。

| **部分**           | **字段**               | **描述**                                                                 |
|--------------------|------------------------|--------------------------------------------------------------------------|
| **UDP报文头**      | 源端口号               | 发送方的UDP端口号                                                        |
|                    | 目标端口号             | 接收方的UDP端口号                                                        |
|                    | 长度                   | UDP报文的总长度，包括UDP头和数据                                          |
|                    | 校验和                 | UDP头和数据部分的校验和，用于检测错误                                     |
| **UDP数据部分**    | 数据（Payload）         | 传输的实际数据内容                                                       |


## TCP帧
| **部分**           | **字段**               | **描述**                                                                 |
|--------------------|------------------------|--------------------------------------------------------------------------|
| **TCP报文头**      | 源端口号               | 发送方的TCP端口号                                                        |
|                    | 目标端口号             | 接收方的TCP端口号                                                        |
|                    | 序列号                 | 该段中第一个字节的序列号，用于数据包排序                                  |
|                    | 确认号                 | 期望接收的数据的下一个序列号，进行数据确认                                |
|                    | 数据偏移               | TCP头部的长度                                                            |
|                    | 保留字段               | 保留供未来使用，一般为0                                                  |
|                    | 控制标志               | 控制标志位，如SYN、ACK、FIN等，控制TCP连接建立、终止和确认                |
|                    | 窗口大小               | 流量控制机制，指示能够接收的字节数                                        |
|                    | 校验和                 | 用于检测TCP头和数据部分是否有错误                                        |
|                    | 紧急指针               | 如果设置了紧急标志位，指示紧急数据的偏移量                                |
| **TCP数据部分**    | 数据（Payload）         | 传输的实际数据内容                                                       |

## HTTP报文

### HTTP请求报文

| **部分**           | **字段**               | **描述**                                                                 |
|--------------------|------------------------|--------------------------------------------------------------------------|
| **起始行**         | 请求方法               | GET、POST、PUT、DELETE等，表示请求的类型                                  |
|                    | 请求URI                | 表示所请求的资源的路径                                                   |
|                    | HTTP版本               | 所使用的HTTP版本（如HTTP/1.1、HTTP/2）                                     |
| **请求头**         | Host                   | 服务器的域名或IP地址                                                      |
|                    | User-Agent             | 客户端的类型，如浏览器或其他应用程序                                      |
|                    | Accept                 | 指定客户端可接受的响应内容类型（如`text/html`、`application/json`等）      |
|                    | Content-Type           | 请求内容的类型（如`application/json`、`application/x-www-form-urlencoded`）|
|                    | Content-Length         | 请求主体的长度                                                            |
|                    | Authorization          | 认证信息，如Bearer token或Basic Auth凭据                                   |
|                    | Cookie                 | 客户端发送的cookie数据                                                    |
| **请求主体**       | 数据                   | POST请求等包含的数据                                                      |

### HTTP响应报文

| **部分**           | **字段**               | **描述**                                                                 |
|--------------------|------------------------|--------------------------------------------------------------------------|
| **起始行**         | HTTP版本               | 响应使用的HTTP版本（如HTTP/1.1、HTTP/2）                                  |
|                    | 状态码                 | 响应状态码（如200 OK、404 Not Found等）                                   |
|                    | 状态描述               | 对状态码的简短描述（如"OK"、"Not Found"等）                                |
| **响应头**         | Date                   | 服务器响应的日期和时间                                                    |
|                    | Server                 | 服务器的类型或名称                                                        |
|                    | Content-Type           | 响应内容的类型（如`text/html`、`application/json`等）                     |
|                    | Content-Length         | 响应内容的长度                                                            |
|                    | Set-Cookie             | 服务器设置的cookie                                                        |
|                    | Cache-Control          | 响应的缓存控制策略                                                        |
| **响应主体**       | 数据                   | 服务器返回的实际数据（如HTML、JSON等）                                     |


## 参考
* [以太网帧格式](https://zh.wikipedia.org/wiki/%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F)