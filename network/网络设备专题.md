 ## OSI 七层模型
 ### 第一层 物理层
物理层（Physical Layer）在局部局域网上传送数据帧（Data Frame），它负责管理电脑通信设备和网络媒体之间的互通。包括了针脚、电压、线缆规范、集线器、中继器、网卡、主机接口卡等。

### 第二层 数据链路层
数据链路层（Data Link Layer）负责网络寻址、错误侦测和改错。当表头和表尾被加至数据包时，会形成信息框（Data Frame）。数据链表头（DLH）是包含了物理地址和错误侦测及改错的方法。数据链表尾（DLT）是一串指示数据包末端的字符串。例如以太网、无线局域网（Wi-Fi）和通用分组无线服务（GPRS）等。

分为两个子层：逻辑链路控制（logical link control，LLC）子层和介质访问控制（Media access control，MAC）子层。

### 第三层 网络层
网络层（Network Layer）决定数据的路径选择和转寄，将网络表头（NH）加至数据包，以形成报文。网络表头包含了网络数据。例如:互联网协议（IP）等。

### 第四层 传输层
传输层（Transport Layer）把传输表头（TH）加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。例如:传输控制协议（TCP）等。

### 第七层 应用层
应用层（Application Layer）提供为应用软件而设的接口，以设置与另一应用软件之间的通信。例如：HTTP、HTTPS、FTP、Telnet、SSH、SMTP、POP3等。

## 网络基础设施
按照网络拓扑结构分类：
- 二层网络：核心层 + 接入层
- 三层网络：核心层 + 汇聚层 + 接入层

**二层网络：**
- 交换机根据MAC地址表进行数据包的转发，有则转发，无则泛洪，即将数据包广播发送到所有端口，如果目的终端收到给出回应，那么交换机就可以将该MAC地址添加到地址表中，这是交换机对MAC地址进行建立的过程
   - 这样频繁的对未知的MAC目标的数据包进行广播，在大规模的网络架构中形成的网络风暴是非常庞大的，这也很大程度上限制了二层网络规模的扩大，因此二层网络的组网能力非常有限，所以一般只是用来搭建小局域网。

**三层网络：**
   - 核心层是整个网络的支撑脊梁和数据传输通道，必须配备高性能的数据冗余转接设备和防止负载过剩的均衡负载的设备，以降低各核心层交换机所需承载的数据量。 
   - 汇聚层是连接网络的核心层和各个接入的应用层，在两层之间承担“媒介传输”的作用。汇聚层设备应采用三层交换机（提供基于策略的连接），具备以下功能： 
      - 实施安全功能（划分VLAN和配置ACL） 
      - 工作组整体接入功能 
      - 虚拟网络过滤功能 
   - 接入层的面向对象主要是终端客户，为终端客户提供接入功能。（将工作站接入网络）

二层网络仅仅通过MAC寻址即可实现通讯，但仅仅是同一个冲突域内；三层网络则需要通过IP路由实现跨网段的通讯，可以跨多个冲突域，aka 设定多个vlan等

三层交换机在一定程度上可以替代路由器，但是应该清醒的认识到三层交换机出现最重要的目的是加快大型局域网内部的数据交换，所具备的路由功能也多是围绕这一目的而展开的，所以他的路由功能没有同一档次的专业路由器强，在安全、协议支持等方面还有许多欠缺，并不能完全取代路由器工作。

在实际应用过程中，典型的做法是：**处于同一个局域网中的各个子网的互联以及局域网中VLAN间的路由，用三层交换机来代替路由器，而只有局域网与公网互联之间要实现跨地域的网络访问时，才通过专业路由器。**

### 以太网保温交互流程
以太网报文：
```shell
7        1   6   6  2           46-1500 4
Preamble SFD DA  SA Length/Type Data    CRC
```

以太网报文格：单播、广播、组播
- 单播：服务器及时响应客户机的请求，服务器针对每个客户不同的请求发送不同的数据，容易实现个性化服务。服务器针对每个客户机发送数据流，服务器流量＝客户机数量×客户机流量。
- 广播：服务器把所有数据发送给每个客户端，不用向每个客户机单独发送数据，所以服务器流量负载极低。网络允许服务器提供数据的带宽有限，客户端的最大带宽＝服务总带宽。
- 组播：向多个目的地址传送数据

### MAC地址
MAC地址是48 bit，前24位为供应商代码。
- 单播地址：第一字节最低位为0，如：00-e0-fc-00-00-06；
- 多播地址：第一字节最低位为1，如：01-e0-fc-00-00-06；
- 广播地址：ff-ff-ff-ff-ff-ff；

### 交换机的工作原理
**交换机作用：**
- 连接多个以太网物理段，隔离冲突域
- 对以太网帧进行高速而透明的交换转发
- 自行学习和维护MAC地址信息
**工作流程：**
1. 学习：交换机内部有一个MAC地址表，一个MAC地址对应一个接口，一个接口可以对应多个MAC地址，与接口相对应的MAC地址是指通过这个接口，交换机所能达到的所有MAC地址，当交换机一端有一个主机通过交换机发送数据，交换机首先查看数据帧的源MAC地址，如果有的话更新记录，如果本身MAC地址中没有相关记录，就将源地址与其进入的接口相关记录写在MAC地址表中。
2. 直接转发：然后再来查看目的MAC地址，如果本身MAC地址表中有关于目的MAC地址与相应接口的记录，就从记录的接口转发出去。
3. 泛洪方式：如果没有记录，交换机就向其他所有接口转发这个帧（除这个数据帧的入口），等到相应的主机单播回复之后，交换机记下回应数据帧的源MAC地址与对应接口，以方便下次转发。
4. 更新：同时，交换机内部的MAC地址表只有300S的存在时间，定时五分钟会更新一次

### 二层交换机 / 三层交换机 / 路由器 区别
三层交换机 = 二层交换机 + 路由功能

#### 二层交换机
二层交换机指的就是传统的工作在OSI参考模型的第二层：数据链路层上交换机，所有的接口同在一个广播域。主要功能包括物理编址、错误校验、帧序列以及流控。 一个纯第二层的解决方案，是最便宜的方案，但它在划分子网和广播限制等方面提供的控制最少。

传统交换机从网桥发展而来，属于OSI第二层即数据链路层设备。它根据MAC地址寻址，通过站表选择路由，站表的建立和维护由交换机自动进行。交换机最大的好处是快速，由于交换机只须识别帧中MAC地址，直接根据MAC地址产生选择转发端口算法简单，便于ASIC实现，因此转发速度极高。交换机的工作机制也带来一些问题。
1. 回路：根据交换机地址学习和站表建立算法，交换机之间不允许存在回路。一旦存在回路，必须启动生成树算法，阻塞掉产生回路的端口。而路由器的路由协议没有这个问题，路由器之间可以有多条通路来平衡负载，提高可靠性。
2. 负载集中：交换机之间只能有一条通路，使得信息集中在一条通信链路上，不能进行动态分配，以平衡负载。而路由器的路由协议算法可以避免这一点，OSPF路由协议算法不但能产生多条路由，而且能为不同的网络应用选择各自不同的最佳路由。
3. 广播控制：交换机只能缩小冲突域，而不能缩小广播域。整个交换式网络就是一个大的广播域，广播报文散到整个交换式网络。而路由器可以隔离广播域，广播报文不能通过路由器继续进行广播。
4. 子网划分：交换机只能识别MAC地址。MAC地址是物理地址，而且采用平坦的地址结构，因此不能根据MAC地址来划分子网。而路由器识别IP地址，IP地址由网络管理员分配，是逻辑地址且IP地址具有层次结构，被划分成网络号和主机号，可以非常方便地用于划分子网，路由器的主要功能就是用于连接不同的网络。
5. 保密问题：虽说交换机也可以根据帧的源MAC地址、目的MAC地址和其他帧中内容对帧实施过滤，但路由器根据报文的源IP地址、目的IP地址、TCP端口地址等内容对报文实施过滤，更加直观方便。
6. 介质相关：交换机作为桥接设备也能完成不同链路层和物理层之间的转换，但这种转换过程比较复杂，不适合ASIC实现，势必降低交换机的转发速度。因此目前交换机主要完成相同或相似物理介质和链路协议的网络互连，而不会用来在物理介质和链路层协议相差甚元的网络之间进行互连。而路由器则不同，它主要用于不同网络之间互连，因此能连接不同物理介质、链路层协议和网络层协议的网络。路由器在功能上虽然占据了优势，但价格昂贵，报文转发速度低。近几年，交换机为提高性能做了许多改进，其中最突出的改进是虚拟网络和三层交换。

划分子网可以缩小广播域，减少广播风暴对网络的影响。路由器每一接口连接一个子网，广播报文不能经过路由器广播出去，连接在路由器不同接口的子网属于不同子网，子网范围由路由器物理划分。对交换机而言，每一个端口对应一个网段，由于子网由若干网段构成，通过对交换机端口的组合，可以逻辑划分子网。广播报文只能在子网内广播，不能扩散到别的子网内，通过合理划分逻辑子网，达到控制广播的目的。由于逻辑子网由交换机端口任意组合，没有物理上的相关性，因此称为虚拟子网，或叫虚拟网。虚拟网技术不用路由器就解决了广播报文的隔离问题，且虚拟网内网段与其物理位置无关，即相邻网段可以属于不同虚拟网，而相隔甚远的两个网段可能属于不同虚拟网，而相隔甚远的两个网段可能属于同一个虚拟网。不同虚拟网内的终端之间不能相互通信，增强了对网络内数据的访问控制。

#### 路由器
路由器转发数据是基于IP地址进行转发，而交换机是基于MAC地址转发。路由器工作于OSI七层协议中的第三层，其主要任务是接收来自一个网络接口的数据包，根据其中所含的目的地址（IP地址进行寻址），决定转发到下一个目的地址。因此，路由器首先得在**转发路由表**中查找它的目的地址，若找到了目的地址，就在**数据包的帧格前添加下一个MAC地址**，同时**IP数据包头的TTL（Time To Live）域也开始减数**，并重新计算校验和。当数据包被送到输出端口时，它需要按顺序等待，以便被传送到输出链路上。

路由器在工作时能够按照某种路由通信协议查找设备中的路由表。如果到某一特定节点有一条以上的路径，则基本预先确定的路由准则是选择最优（或最经济）的传输路径。由于各种网络段和其相互连接情况可能会因环境变化而变化，因此路由情况的信息一般也按所使用的路由信息协议的规定而定时更新。

#### 三层交换机
三层交换机工作在网络层，能转发多网段的数据。三层交换技术就是将路由技术与交换技术合二为一的技术。在对第一个数据流进行路由后，它将会产生一个MAC地址与IP地址的映射表，当同样的数据流再次通过时，将根据此表直接从二层通过而不是再次路由，从而消除了路由器进行路由选择而造成网络的延迟，提高了数据包转发的效率。

三层交换（也称多层交换技术，或IP交换技术）：二层交换技术＋三层转发技术。它解决了局域网中网段划分之后，网段中子网必须依赖路由器进行管理的局面，解决了传统路由器低速、复杂所造成的网络瓶颈问题。

**例子**：假设两个使用IP协议的站点A、B通过第三层交换机进行通信，发送站点A在开始发送时，把自己的IP地址与B站的IP地址比较，判断B站是否与自己在同一子网内。若目的站B与发送站A在同一子网内，则进行二层的转发。若两个站点不在同一子网内，如发送站A要与目的站B通信，发送站A要向“缺省网关”发出ARP(地址解析)封包，而“缺省网关”的IP地址其实是三层交换机的三层交换模块。当发送站A对“缺省网关”的IP地址广播出一个ARP请求时，如果三层交换模块在以前的通信过程中已经知道B站的MAC地址，则向发送站A回复B的MAC地址。否则三层交换模块根据路由信息向B站广播一个ARP请求，B站得到此ARP请求后向三层交换模块回复其MAC地址，三层交换模块保存此地址并回复给发送站A,同时将B站的MAC地址发送到二层交换引擎的MAC地址表中。从这以后，当A向B发送的数据包便全部交给二层交换处理，信息得以高速交换。由于仅仅在路由过程中才需要三层处理，绝大部分数据都通过二层交换转发，因此三层交换机的速度很快，接近二层交换机的速度，同时比相同路由器的价格低很多。

**三层交换机完全能够执行传统路由器的大多数功能，具有以下特征：**
- 转发基于第三层地址的业务流；
- 完全交换功能；
- 可以完成特殊服务，如报文过滤或认证；
- 执行或不执行路由处理。

- **三层交换机与传统路由器相比有如下优点：**
- **子网间传输带宽可任意分配**：传统路由器每个接口连接一个子网，子网通过路由器进行传输的速率被接口的带宽所限制。而三层交换机则不同，它可以把多个端口定义成一个虚拟网，把多个端口组成的虚拟网作为虚拟网接口，该虚拟网内信息可通过组成虚拟网的端口送给三层交换机，由于端口数可任意指定，子网间传输带宽没有限制。
- **合理配置信息资源**：由于访问子网内资源速率和访问全局网中资源速率没有区别，子网设置单独服务器的意义不大，通过在全局网中设置服务器群不仅节省费用，更可以合理配置信息资源。
- **降低成本**：通常的网络设计用交换机构成子网，用路由器进行子网间互连。目前采用三层交换机进行网络设计，既可以进行任意虚拟子网划分，又可以通过交换机三层路由功能完成子网间通信，为此节省了价格昂贵的路由器。
- **交换机之间连接灵活**：作为交换机，它们之间不允许存在回路，作为路由器，又可有多条通路来提高可靠性、平衡负载。三层交换机用生成树算法阻塞造成回路的端口，但进行路由选择时，依然把阻塞掉的通路作为可选路径参与路由选择。

## VLan
二层交换机使用VLAN（虚拟局域网）隔离广播，用来减小广播域范围。这样的话，不同VLAN之间是无法进行通信的，假设PCA发送一个广播帧，只会在VLAN1之间传播并不会传播到VLAN2，这样既限制了广播域的范围，又保证了VLAN2的安全性。

VLan优点：
- 有效控制广播域范围
- 增强局域网的安全性
- 灵活构建虚拟工作组

VLan分类：
- 基于端口
- 基于MAC地址
- 基于协议
- 基于子网

- VLan标签：
- 数据中进入交换机端口的时候打上的。在标准的以太网帧的源地址SA和类型Type之间打上的Tag标签，此tag标签中含有VLAN ID，VLAN ID的范围为4096，去掉一个默认的vlan 1和vlan4096作为保留vlan，实际可用的vlan ID个数为4094个。
- 在出交换机的时候交换机需要对数据帧的VLAN标签进行剥离再转发给相对应的PC。

- 链路类型：
- Access链路：指允许缺省的 VLAN 通过，同时仅发送和接收一个 VLAN 的数据帧。
适用于连接用户设备，也就是交换机直接连接终端设备时使用Access链路。
- Trunk链路：允许多个 VLAN 通过，可以接收和发送多个 VLAN 的数据帧。同时对于缺省的 VLAN 也就是 PVID 的以太网帧是不带标签的。
   - 用于交换机之间的连接
- Hybrid链路

### VLan互通
#### 单臂路由方式
#### 三层交换方式

## 旁路设备
设备在网络中的位置可以分为直路和旁路。如果仅需要对流量进行监控、统计和记录，不需设备转发流量，可以选择旁路模式部署。使用旁路模式，主干网络不会被旁路设备可能发生的故障所影响，所以，对于仅有审计需求的情况，部署旁路模式更加有效合理。

使用一根RJ-45网线，将主干网络交换机的镜像接口eth0/4与旁路设备的旁路接口eth0/1相连接。

旁路设备可用的威胁检测功能：
- 入侵防御（IPS）
- 应用识别：基于APP DB模式库
- 高级威胁检测（ATD）
- 异常行为检测（ABD）

## TUN / TAP 虚拟设备
在计算机网络中，TUN与TAP是操作系统内核中的虚拟网络设备。不同于普通靠硬件网络适配器实现的设备，这些虚拟的网络设备全部用软件实现，并向运行于操作系统上的软件提供与硬件的网络设备完全相同的功能。

TAP等同于一个以太网设备，它操作第二层数据包如以太网数据帧。TUN模拟了网络层设备，操作第三层数据包比如IP数据封包。

操作系统通过TUN/TAP设备向绑定该设备的用户空间的程序发送数据，反之，用户空间的程序也可以像操作硬件网络设备那样，通过TUN/TAP设备发送数据。在后种情况下，TUN/TAP设备向操作系统的网络栈投递（或“注入”）数据包，从而模拟从外部接受数据的过程。

## 网络攻击
### 网络风暴
* [网络链路洪泛原理，黑客利用洪泛漏洞发起破坏攻击](https://kuaibao.qq.com/s/20190908A0IC1500)
* [网络风暴产生的原因及防御原理，必备通信知识](https://kuaibao.qq.com/s/20190909A0O7CG00)
* [解网络流量控制，反压技术原理](https://kuaibao.qq.com/s/20190910A0NP6E00)

## 参考
* [两层网络、三层网络的理解](https://blog.csdn.net/cj2580/article/details/80107037)
* [交换机工作原理详解（附原理图）](https://zhuanlan.zhihu.com/p/122241071)
* [一文轻松理解vlan虚拟局域网到底是什么，图解vlan流程](https://kuaibao.qq.com/s/20190830A0JGPM00 )
* [不同VLAN之间相互通信的两种方式（单臂路由、三层交换）](https://blog.51cto.com/dreamfire/121273)
* [一文轻松了解vlan端口模式Access，Trunk通信理论](https://kuaibao.qq.com/s/20190901A0DJAK00)
* [一文轻松了解vlan端口模式之Trunk是什么，开发必备通信](https://kuaibao.qq.com/s/20190901A0FU7Y00)
* [山石网科技术文档在线系统](http://docs.hillstonenet.com/cn/Content/Home.htm)
* [例7：部署旁路模式，监控主干网络的应用、威胁和攻击](http://docs.hillstonenet.com/cn/Content/Cookbook/cb14-tapmode.htm) 包含了一些山石网科界面实例
* [部署旁路（Tap）模式](http://docs.hillstonenet.com/cn/Content/3_Deploy_Your_Device/tap_mode.htm)
* [网络通信之镜像，端口镜像是什么](https://kuaibao.qq.com/s/20190913A0GH4Y00)
